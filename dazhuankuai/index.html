<!DOCTYPE html>
<html lang="en">
<head>
    <!--适配-->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width,minimum-scale=1,user-scalable=no,maximum-scale=1,initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="format-detection" content="telephone=no">  
	<meta http-equiv="x-rim-auto-match" content="none">  
    <!--适配-->
    <title>打砖块DEMO</title>
    <!--距离关节就是指刚体中点之间的距离不变-->
    <style>
            *,
        ::before,
        ::after {
        padding: 0;
        margin: 0;
        -webkit-tap-highlight-color: transparent;
        -webkit-box-sizing: border-box;
        box-sizing: border-box; }

        #dazhuankuai_game {
            width: 16rem !important;
            margin: 0 auto;}

        #dazhuankuai_game canvas {
            width: 16rem !important;
            margin: 0 auto;}

    </style>
</head>
<!--加上font-size:0;解决1.9.7白底边bug-->
<body style="font-size:0;">
    <div id="dazhuankuai_game"></div>
    <script src="../js/jquery.js"></script>
    <script src="../js/Box2dWeb-2.1.a.3.min.js"></script>
    <script src="../js/lufylegend-1.10.1.js"></script>
    <script>
    ;(function (doc, win) {
        var docEl = doc.documentElement,
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
                recalc = function () {
            var clientWidth = docEl.clientWidth;
            if (!clientWidth) return;
            if(clientWidth > 800) clientWidth=800;
            docEl.style.fontSize = 20 * (clientWidth / 320) + 'px';
        };
        
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        recalc();
    })(document, window);
        
    ;(function(){
        // 问题： setBodyMouseJoint失效
        // 全局配置G
        var G = {
            // 游戏状态
            "globalState": 1,
            // canvas ID
            "canvasId":"dazhuankuai_game",
            // 画布宽
            "GAME_WIDTH": 640,
            // 画布高
            "GAME_HEIGHT": 640*window.innerHeight/window.innerWidth,
            // 背景层
            "backLayer": null,
            // 加载层
            "loadingLayer": null,
            // 舞台层
            "stageLayer": null,
            // 图片缓存
            "imglist": {},
            // 地板刚体
            "floor": null,
            // 发射区域圆心
            "point": {x:320,y:640*window.innerHeight/window.innerWidth-120-15},
            // 小球
            "ball": null
        }
        var imgData = new Array({
            name: "bg2",
            path: "./images/bg2.jpg"
        },{
            name: "top",
            path: "./images/top.png"
        },{
            name: "wall",
            path: "./images/juxing.png"
        },{
            name: "sprite",
            path: "./images/sprite.png"
        });
        // $("#dazhuankuai_game").css("height",G.GAME_HEIGHT);
        // $("#dazhuankuai_game canvas").css("height",G.GAME_HEIGHT);
        LInit(10, G.canvasId , G.GAME_WIDTH, G.GAME_HEIGHT, start);

        // 进程
        function start(){
            LGlobal.setDebug(true);
            
            // 实现移动端适配，1.6以后才能使用这个API
            LGlobal.align = LStageAlign.TOP_LEFT;
            LGlobal.stageScale = LStageScaleMode.SHOW_ALL;
            LSystem.screen(LStage.FULL_SCREEN);
            G.backLayer = new LSprite();
            addChild(G.backLayer);
            //利用LLoadManage读取图片, 显示进度条, 执行init
            G.loadingLayer = new LoadingSample5(12);
            G.backLayer.addChild(G.loadingLayer);
            G.backLayer.removeAllChild(G.loadingLayer);
            LLoadManage.load(
                imgData,
                function(progress) {
                    G.loadingLayer.setProgress(progress);
                },
                // 不能写init,冲突
                initGame
            );  
        }

        function initGame(result) {
            //取得图片读取结果
            G.imglist = result;
            //移除进度条
            G.backLayer.removeAllChild(G.loadingLayer);
            G.loadingLayer = null;
            //游戏逻辑
            main();
        }

        function main() {
            // 格式化背景层
            G.backLayer.die();
            G.backLayer.removeAllChild();
            // 加载游戏背景实例
            bgo = new Background(); 
            G.backLayer.addChild(bgo);
            // 初始化Box2dweb 
            LGlobal.box2d = new LBox2d();

            // 舞台初始化
            stageInit();   
            // 添加头部实例
            var top = new Top();
            top.x = 320;
            top.y = 62.5;
            G.stageLayer.addChild(top);
            top.addBodyPolygon(640,125,0,5,0.4,0.5);

            // 通过顶点坐标加入2面墙
            var wall1 = new Wall();
            wall1.x = 11;
            wall1.y = G.GAME_HEIGHT/2;
            G.stageLayer.addChild(wall1);
            wall1.addBodyPolygon(22,G.GAME_HEIGHT,0,5,0.4,0.5);

            var wall2 = new Wall();
            wall2.x = 640-11;
            wall2.y = G.GAME_HEIGHT/2;
            G.stageLayer.addChild(wall2);
            wall2.addBodyPolygon(22,G.GAME_HEIGHT,0,5,0.4,0.5);
            // 设置层级,最底下调到最上面
            G.stageLayer.setChildIndex(G.stageLayer.getChildAt(0), G.stageLayer.numChildren-1);

            // 设置底部的地板
            G.floor = new Floor();
            G.floor.x = 320;
            G.floor.y = G.GAME_HEIGHT-120+8;
            G.stageLayer.addChild(G.floor);
            G.floor.addBodyPolygon(130,16,0,5,0.4,6);
            // 添加移动
            G.backLayer.addEventListener(LMouseEvent.MOUSE_DOWN, onmouse);

            // 小球
            G.ball = new Ball();
            G.ball.x = G.point.x;
            G.ball.y = G.point.y;
            G.backLayer.addChild(G.ball);
            G.ball.addBodyCircle(15,0,0,1,5,0.5,0.6);
            // var angle = Math.PI/4;
            // var force = 2000;
            // var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle));
            // G.ball.box2dBody.ApplyForce(vec,G.ball.box2dBody.GetWorldCenter());

            // 方块
            var box = new Box();
           
            // addWawa();
            // armO = new Arm(); //手臂
            // // armO.graphics.drawRect(2, "#ff0000", [armO.x-14, armO.y, armO.getWidth(), armO.getHeight()], true, "#880088");
            // stageLayer.addChild(armO);
            // globalState = 1;
            // //动画
            // backLayer.addEventListener(LEvent.ENTER_FRAME, onframe);
        }
        function onmouse(event) {
            console.log(event.offsetX);
            if(640>event.offsetX && event.offsetX>320){
                G.floor.box2dBody.SetPosition(new LGlobal.box2d.b2Vec2(G.floor.box2dBody.GetPosition().x+1,G.floor.box2dBody.GetPosition().y));
            }else if(0<event.offsetX && event.offsetX<=320){
                G.floor.box2dBody.SetPosition(new LGlobal.box2d.b2Vec2(G.floor.box2dBody.GetPosition().x-1,G.floor.box2dBody.GetPosition().y));
            }
            G.floor.box2dBody.SetAwake(true);
        }
        // 背景层，舞台层，顶层，地板层，射击层，小球层，方块层
        function Background() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["bg2"],0,0,640,1030);
            self.bitmap = new LBitmap(self.bitmapData);
            var sy = G.GAME_HEIGHT/self.bitmapData.height;// 缩放，将背景图拉伸至全屏
            self.bitmap.scaleY = sy;
            self.addChild(self.bitmap);
        }
        function stageInit() {
            G.stageLayer = new LSprite();
            G.backLayer.addChild(G.stageLayer);
        } 
        function Top() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["top"],0,0,640,133);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap);
        }
        function Wall() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["wall"],0,0,22,1006);
            self.bitmap = new LBitmap(self.bitmapData);
            var sy = G.GAME_HEIGHT/self.bitmapData.height;// 缩放，将背景图拉伸至全屏
            self.bitmap.scaleY = sy;
            self.addChild(self.bitmap);
        }
        function Floor() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["sprite"],537,166,130,16);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap);
        }
        function ShootArea() {
            base(this, LSprite, []);
        }
        function Ball() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["sprite"],359,158,30,29);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap); 
        }
        function Box() {
            var self = this;
            self.box1 = [[1,1,1,1],
                         [1,1,1,0],
                         [1,1,0,0],
                         [1,0,0,0]];
            self.box2 = [[1,0,0,0],
                         [1,1,0,0],
                         [1,1,1,0],
                         [1,1,1,1]];
            self.box3 = [[1,1,1,1],
                         [0,1,1,1],
                         [0,0,1,1],
                         [0,0,0,1]];
            self.box4 = [[0,0,0,1],
                         [0,0,1,1],
                         [0,1,1,1],
                         [1,1,1,1]];
            self.box5 = [[0,0,1,1,0,0],
                         [0,1,1,1,1,0],
                         [1,1,1,1,1,1],
                         [1,1,1,1,1,1]
                         [0,1,1,1,1,0],
                         [0,0,1,1,0,0],];
        }
        Box.prototype = {
            getBox1:function() {
                var self = this;

            }
        }














        // // 距离关节
        // var Global = {
        //     // 游戏状态
        //     "globalState": 1,
        //     // canvas ID
        //     "canvasId":"dazhuankuai_game",
        //     // 画布宽
        //     "GAME_WIDTH": 640,
        //     // 画布高
        //     "GAME_HEIGHT": 700,
        //     // 背景层
        //     "backLayer": null,
        //     // 舞台层
        //     "stageLayer": null,
        //     // 图片缓存
        //     "imglist": {}
        // }
        // var imgData = new Array({
        //     name:"bg2",
        //     path:"./images/bg2.jpg"
        // });

        // init(10, Global.canvasId , Global.GAME_WIDTH, Global.GAME_HEIGHT, start);

        // var loadingLayer;
        // function start() {
        //     // LGlobal.setDebug(true);
        //     // // 初始化Box2dweb
        //     // LGlobal.box2d = new LBox2d();
        //     // Global.backLayer = new LSprite();
        //     // Global.backLayer.graphics.drawRect(1, "#000000", [0, 0, GAME_WIDTH, GAME_HEIGHT], true, "#000000");
        //     // addChild(Global.backLayer);

        //     // // 读取图片，显示进度条，初始化
        //     // loadingLayer = new LoadingSample5(12);
        //     // Global.backLayer.addChild(loadingLayer);
        //     // LLoadManage.load(
        //     //     imgData,
        //     //     function(progress) {
        //     //         loadingLayer.setProgress(progress);
        //     //     },
        //     //     init
        //     // );  
        //     Global.backLayer = new LSprite();
        //     //在背景精灵上绘制黑色背景
        //     addChild(Global.backLayer);
        //     //利用LLoadManage读取图片，并显示进度条,执行init
        //     loadingLayer = new LoadingSample5(12);
        //     backLayer.addChild(loadingLayer);
        //     LLoadManage.load(
        //         imgData,
        //         function(progress) {
        //             loadingLayer.setProgress(progress);
        //         },
        //         init
        //     );  
        // }

        // function init(result) {
        //     //取得图片读取结果
        //     Global.imglist = result;
        //     //移除进度条
        //     Global.backLayer.removeAllChild(loadingLayer);
        //     loadingLayer = null;
        //     //游戏主进程开始
        //     main();
        // }

        // function main() {
        //     // 全屏
        //     LGlobal.align = LStageAlign.TOP_LEFT;
        //     LGlobal.stageScale = LStageScaleMode.SHOW_ALL;
        //     LSystem.screen(LStage.FULL_SCREEN);
        //     // 格式化游戏背景
        //     Global.backLayer.die();
        //     Global.backLayer.removeAllChild();
        //     // 加载游戏背景实例
        //     bgO = new Background(); 
        //     Global.backLayer.addChild(bgO);
           

        //     // var cplayer  = new LSprite();
        //     // cplayer.x = 300;//刚体中点的x坐标
        //     // cplayer.y = 390;//刚体中点的y坐标
        //     // // 添加钢体
        //     // Global.backLayer.addChild(cplayer);
        //     // cplayer.addBodyPolygon(640,10,0,5,0.4,0.2);//刚体的宽和高，动/静态，密度，摩擦，弹力                        

        //     // // 加入一个动态的圆形物体
        //     // var box = new LSprite();
        //     // box.x = 250;
        //     // box.y = 200;
        //     // Global.backLayer.addChild(box);
        //     // box.addBodyCircle(100,0,0,1,5,0.4,0.2);
        //     // box.setBodyMouseJoint(true);

        //     // // 加入一个动态的矩形物体2
        //     // var box2  =  new LSprite();
        //     // box2.x = 400;               
        //     // box2.y = 100;
        //     // Global.backLayer.addChild(box2);
        //     // box2.addBodyPolygon(100,60,1,5,0.4,0.2);
        //     // box2.setBodyMouseJoint(true);

        //     // // 加入一个距离关节
        //     // LGlobal.box2d.setDistanceJoint(box.box2dBody,box2.box2dBody);

        // }
        // // 背景类
        // function Background() {
        //     base(this, LSprite, []);
        //     var self = this;
        //     self.bitmapData = new LBitmapData(imglist["bg2"],0,0,GAME_WIDTH,GAME_HEIGHT);
        //     self.bitmap = new LBitmap(self.bitmapData);
        //     self.addChild(self.bitmap);
        // }
    })();
       

        
    </script>
</body>
</html>