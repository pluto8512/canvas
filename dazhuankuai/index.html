<!DOCTYPE html>
<html lang="en">
<head>
    <!--适配-->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width,minimum-scale=1,user-scalable=no,maximum-scale=1,initial-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="format-detection" content="telephone=no">  
	<meta http-equiv="x-rim-auto-match" content="none">  
    <!--适配-->
    <title>打砖块DEMO</title>
    <!--距离关节就是指刚体中点之间的距离不变-->
    <style>
            *,
        ::before,
        ::after {
        padding: 0;
        margin: 0;
        -webkit-tap-highlight-color: transparent;
        -webkit-box-sizing: border-box;
        box-sizing: border-box; }

        #dazhuankuai_game {
            width: 16rem !important;
            margin: 0 auto;}

        #dazhuankuai_game canvas {
            width: 16rem !important;
            margin: 0 auto;}

    </style>
</head>
<!--加上font-size:0;解决1.9.7白底边bug-->
<body style="font-size:0;">
    <div id="dazhuankuai_game"></div>
    <script src="./js/jquery.js"></script>
    <script src="./js/Box2dWeb-2.1.a.3.min.js"></script>
    <script src="./js/lufylegend-1.10.1.js"></script>
    <script>
    ;(function (doc, win) {
        var docEl = doc.documentElement,
        resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
                recalc = function () {
            var clientWidth = docEl.clientWidth;
            if (!clientWidth) return;
            if(clientWidth > 800) clientWidth=800;
            docEl.style.fontSize = 20 * (clientWidth / 320) + 'px';
        };
        
        if (!doc.addEventListener) return;
        win.addEventListener(resizeEvt, recalc, false);
        recalc();
    })(document, window);
        
    ;(function(){
         function gameover(gameOverCallback) {
            // // alert("游戏结束"+"分数为："+G.score+"剩余时间为："+G.time_surplus); 
            // G.backLayer.die();
            // G.backLayer.removeAllChild();   
            // G.stageLayer.die();
            // G.stageLayer.removeAllChild();
            // //提交分数
            // window.game.score(G.score , G.time_surplus , {url:"/mobile/participation/commitscore" , refreshScore:true ,data:{
            //     "score": 100,
            //     "needFollow": true,
            //     "noFailPopUp": true
            // }});
            alert("gameove!");
        }
        // 问题： setBodyMouseJoint失效
        // 全局配置G
        var G = {
            // 游戏状态(1:游戏开始时2:球已经发射)
            "globalState": 1,
            // canvas ID
            "canvasId":"dazhuankuai_game",
            // 画布宽
            "GAME_WIDTH": 640,
            // 画布高
            "GAME_HEIGHT": 640*window.innerHeight/window.innerWidth,
            // 背景层
            "backLayer": null,
            // 加载层
            "loadingLayer": null,
            // 舞台层
            "stageLayer": null,
            // 图片缓存
            "imglist": {},
            // 地板刚体
            "floor": null,
            // 发射区域圆心
            "point": {x:320,y:640*window.innerHeight/window.innerWidth-120-15},
            // 小球
            "ball": null,
            // 点击的初始位置
            "STARTX": 0,
            // 位移
            "distance": 0,
            // 倒计时文字
            "field": null,
            // 分数文字
            "fieldScore": null,
            // 游戏倒计时
            "fieldTime": null,
            // 开启距离计算
            "flag": false ,
            // 保存球的位置的数组
            "posiArr": [],
            // 重弹标志(y轴上)
            "reflag": false,
            // 重弹标志(x轴上)
            "reflag_x": false,
            // 来球方向标志(false:右方true:左方)
            "direflag": false,
            // 墙上来球的随机方向(false:右方true:左方)
            "walldireflag": false,
            // 光圈
            "halo": null,
            // 光圈缓动播完标志
            "overflag": true,
            // 方块被撞击次数
            "num": 0,
            // 碰撞跟踪对象(flag:掉粽子x/y:撞击时的坐标)
            "PSO" : {"flag":false,"x":0,"y":0},
            // 分数
            "score": 0,
            // 球2
            "ball2": null,
            // 保存球2的位置的数组
            "posiArr2": [],
            // 球2的来球方向标志(false:右方true:左方)
            "direflag2": false,
            // SK1和挡板碰撞跟踪对象(flag:加球标志x/y:撞击时的坐标)
            "PSO_SK1FLOOR":{ "flag": false,"x":0,"y":0},
            // SK4和挡板碰撞跟踪对象(flag:加球标志x/y:撞击时的坐标)
            "PSO_SK4FLOOR":{ "flag": false,"x":0,"y":0},
            // 小球和底墙碰撞跟踪对象(flag:换球标志x/y:撞击时的坐标)
            "PSO_BALLWALL_B":{"flag": false,"x":0,"y":0},
            // 小球和挡板碰撞跟踪对象(flag:换球标志x/y:撞击时的坐标)
            "PSO_BALLFLOOR":{"flag": false,"x":0,"y":0},
            // 小球和两边墙碰撞跟踪对象(flag:换球标志x/y:撞击时的坐标)
            "PSO_BALLWALL":{"flag": false,"x":0,"y":0},
            // 通用弹力指数
            "normal_config" : 0,
            // 地板弹力指数
            "floor_Config" : 0,
            // 小球密度
            "midu_config": 2,
            // 小球的弹力1
            "boll_config": 1,
            // 小球第一次发射时的力度
            "force": 200,
            // 重力系数
            "g": 9.8,
            // 通用摩擦力
            "mormal_config2":0,
            // 小球和球板碰撞时外加力
            "forcefloorball":0.8,
            // 小球和墙碰撞时外加力
            "forcewallball":0.4,
            // 道具对象保存数组
            "daojuArr": [],
            // (粽子)道具下落的速度
            "down_v": 3,
            // 底墙的刚体代表
            "bottomwall1": null,
            // 超速的标准
            "config_impulse":12
        }
        var imgData = new Array({
            name: "bg2",
            path: "./images/bg2.jpg"
        },{
            name: "top",
            path: "./images/top.png"
        },{
            name: "wall",
            path: "./images/juxing.png"
        },{
            name: "sprite",
            path: "./images/sprite.png"
        });
        
        LInit(10, G.canvasId , G.GAME_WIDTH, G.GAME_HEIGHT, start);

        // 进程
        function start(){
            LGlobal.setDebug(true);
            
            //预读取音频
            var loadsound = true;
            var protocol = location.protocol;
            if (protocol == "http:" || protocol == "https:") {
                if (LGlobal.ios && !LSound.webAudioEnabled){
                    //如果IOS环境，并且不支持WebAudio，则无法预先读取
                    loadsound = false;
                }
            } else if (LGlobal.mobile) {
                //如果是移动浏览器本地访问，则无法预先读取
                loadsound = false;
            }
            if(loadsound){
                imgData.push({name : "sound_background",path : "./images/game music.mp3"});
                if(LSound.webAudioEnabled){
                    //浏览器支持WebAudio,则预先读取所有音频
                    imgData.push({name : "duang",path : "./images/duang.wav"});
                }
            }

            // 实现移动端适配，1.6以后才能使用这个API
            LGlobal.align = LStageAlign.TOP_LEFT;
            LGlobal.stageScale = LStageScaleMode.SHOW_ALL;
            LSystem.screen(LStage.FULL_SCREEN);
            G.backLayer = new LSprite();
            addChild(G.backLayer);
            //利用LLoadManage读取图片, 显示进度条, 执行init
            G.loadingLayer = new LoadingSample5(12);
            G.backLayer.addChild(G.loadingLayer);
            G.backLayer.removeAllChild(G.loadingLayer);
            LLoadManage.load(
                imgData,
                function(progress) {
                    G.loadingLayer.setProgress(progress);
                },
                // 不能写init,冲突
                initGame
            );  
        }

        function initGame(result) {
            //取得图片读取结果
            G.imglist = result;
            //移除进度条
            G.backLayer.removeAllChild(G.loadingLayer);
            G.loadingLayer = null;
            //播放音乐
            MySoundPlayer = new SoundPlayer();
            //游戏逻辑
            main();
        }

        function main() {
            // 格式化背景层
            G.backLayer.die();
            G.backLayer.removeAllChild();
            // 加载游戏背景实例
            bgo = new Background(); 
            G.backLayer.addChild(bgo);
            // 初始化Box2dweb 
            LGlobal.box2d = new LBox2d();

            // 舞台初始化
            stageInit();   
            // 添加头部实例
            var top = new Top();
            top.x = 320;
            top.y = 62.5;
            G.stageLayer.addChild(top);
            top.addBodyPolygon(640,125,0,10,G.mormal_config2,G.normal_config);

            // 通过顶点坐标加入2面墙
            var wall1 = new Wall();
            wall1.x = 11;
            wall1.y = G.GAME_HEIGHT/2;
            G.stageLayer.addChild(wall1);
            wall1.addBodyPolygon(22,G.GAME_HEIGHT,0,10,G.mormal_config2,G.normal_config);

            var wall2 = new Wall();
            wall2.x = 640-11;
            wall2.y = G.GAME_HEIGHT/2;
            G.stageLayer.addChild(wall2);
            wall2.addBodyPolygon(22,G.GAME_HEIGHT,0,10,G.mormal_config2,G.normal_config);
            // 设置层级,最底下调到最上面
            G.stageLayer.setChildIndex(G.stageLayer.getChildAt(0), G.stageLayer.numChildren-1);

            // 设置底部的地板
            G.floor = new Floor();
            G.floor.x = 320;
            G.floor.y = G.GAME_HEIGHT-120+8;
            G.stageLayer.addChild(G.floor);
            G.floor.addBodyPolygon(130,16,0,1,G.mormal_config2,G.floor_Config);
            // 添加移动
            G.backLayer.addEventListener(LMouseEvent.MOUSE_DOWN, onmousedown);
            G.backLayer.addEventListener(LMouseEvent.MOUSE_MOVE, onmousemove);
            G.backLayer.addEventListener(LMouseEvent.MOUSE_UP, onmouseup);

            // 小球
            G.ball = new Ball();
            G.ball.x = G.point.x;
            G.ball.y = G.point.y;
            G.stageLayer.addChild(G.ball);
            G.ball.addBodyCircle(15,0,0,1,G.midu_config,G.mormal_config2,G.boll_config);
            // 倒计时3s,随机发射
            G.field = new LTextField();
            G.backLayer.addChild(G.field);
            doTimeDown(3);
            // 分数
            G.fieldScore = new LTextField();
            G.backLayer.addChild(G.fieldScore);
            markScore("00");
            // 时间
            G.fieldTime = new LTextField();
            G.fieldTime.text = 300;
            G.backLayer.addChild(G.fieldTime);
            writeTime(300,G.fieldTime,204,53,20,"white");
            // 加入碰撞侦听事件
            LGlobal.box2d.setEvent(LEvent.POST_SOLVE,postSolve);
            
            // 方块
            var box1 = new Box();
            box1.getHardBox(box1.box1,22,188,G.imglist["sprite"],[23,157,52,48]);
            var box2 = new Box();
            box2.getHardBox(box2.box2,22,430,G.imglist["sprite"],[23,157,52,48]);
            var box3 = new Box();
            box3.getHardBox(box3.box3,410,188,G.imglist["sprite"],[23,157,52,48]);
            var box4 = new Box();
            box4.getHardBox(box4.box4,410,430,G.imglist["sprite"],[23,157,52,48]);
            var box5 = new Box();
            box5.getBox(box5.box5,164,263,G.imglist["sprite"],[131,157,52,48]);

            // 底墙
            G.bottomwall1 = new bottomWall();
            G.bottomwall1.getbottomWall(84,G.GAME_HEIGHT-350);
            var bottomwall2 = new bottomWall();
            bottomwall2.getbottomWall(272,G.GAME_HEIGHT-350);
            var bottomwall3 = new bottomWall();
            bottomwall3.getbottomWall(459,G.GAME_HEIGHT-350);

            // 循环动画
            G.backLayer.addEventListener(LEvent.ENTER_FRAME, onframe);
        }
        // 跟踪
        function onframe() {
            switch(G.globalState){
                // 游戏过程中
                case 2:
                    // 小球跑出屏幕，游戏结束
                    if(G.ball.y>G.GAME_HEIGHT){
                        G.globalState = 3;
                    }

                    nog(G.ball.box2dBody);//消去小球重力
                    
                    for(var i=0;i<G.daojuArr.length;i++){
                        // 坐标不是物理世界的坐标(G.floor.y-60粽子刚好要接触球板,32是粽子图片宽的一半)
                        G.daojuArr[i].y += G.down_v;
                        if(G.daojuArr[i].y >= G.floor.y-60 && G.daojuArr[i].y <= G.floor.y-60+G.floor.getHeight()){
                            if((G.floor.x-G.floor.getWidth()/2)<G.daojuArr[i].x+32 && G.daojuArr[i].x-32<(G.floor.x+G.floor.getWidth()/2)){
                                 G.stageLayer.removeChild(G.daojuArr[i]);
                                 G.score += 20;
                                 console.log(G.score);
                                 markScore(G.score);//刷新分数
                                 G.daojuArr[i]=null;
                                 G.daojuArr.splice(i, 1);//返回指定的元素,javascript 清除数组中的空元素
                            }
                        }
                    }
                    for(var i=0;i<G.daojuArr.length;i++){
                         if(G.daojuArr[i].y>G.GAME_HEIGHT){
                             G.stageLayer.removeChild(G.daojuArr[i]);
                             G.daojuArr[i]=null;
                             G.daojuArr.splice(i, 1);//返回指定的元素,javascript 清除数组中的空元素
                        }
                    }
                    // 跟踪小球坐标
                    if(G.posiArr.length<30) {
                        G.posiArr.push({"x":G.ball.x,"y":G.ball.y});
                    }else {
                        G.posiArr.shift();
                        G.posiArr.push({"x":G.ball.x,"y":G.ball.y});
                    }
                    // 小球左方射入(true)
                    if( G.posiArr.length==30 &&　G.posiArr[0].x < G.posiArr[29].x ) {
                        G.direflag = true;
                    }else if( G.posiArr.length==30　&&　G.posiArr[0].x >= G.posiArr[29].x ) {
                        G.direflag = false;
                    }
                    // 小球上方射入(true)
                    if( G.posiArr.length==30 &&　G.posiArr[0].y < G.posiArr[29].y ) {
                        G.walldireflag = true;
                    }else if( G.posiArr.length==30　&&　G.posiArr[0].y >= G.posiArr[29].y ) {
                        G.walldireflag = false;
                    }
                    // 小球原地重弹(y轴)
                    if(G.posiArr.length==30 &&　G.posiArr[0].x == G.posiArr[14].x && G.posiArr[14].x == G.posiArr[29].x){
                        G.reflag = true;
                    }else {
                        G.reflag = false;
                    }
                    // 小球原地重弹(x轴)
                    if(G.posiArr.length==30 &&　G.posiArr[0].y == G.posiArr[14].y && G.posiArr[14].y == G.posiArr[29].y){
                        G.reflag_x = true;
                    }else {
                        G.reflag_x = false;
                    }
                    // 跟踪小球2的运动状态
                    if(G.ball2) {
                        // 跟踪小球2坐标
                        if(G.posiArr2.length<30) {
                            G.posiArr2.push({"x":G.ball2.x,"y":G.ball2.y});
                        }else {
                            G.posiArr2.shift();
                            G.posiArr2.push({"x":G.ball2.x,"y":G.ball2.y});
                        }
                        // 左方
                        if( G.posiArr2.length==30 &&　G.posiArr2[0].x < G.posiArr2[29].x ) {
                            G.direflag2 = true;
                        }else if( G.posiArr2.length==30　&&　G.posiArr2[0].x >= G.posiArr2[29].x ) {
                            G.direflag2 = false;
                        }
                    }
                    // 方块和小球的"碰撞后"跟踪(SK1:双球SK2:小球加速SK3:直接死亡SK4:球板变短)
                    if (G.PSO.flag){
                        G.PSO.flag = false;
                        // var flag = parseInt(Math.random*10);
                        // switch(flag){
                        //     case 1,2,3:
                        //         // 创建粽子(可用)
                                createZongzi();
                        //     break;
                        //     case 4:
                        //         // 创建粽子(可用)
                        //         createZongzi();
                        //     break;
                        //     case 5:
                        //         // 创建双球道具(SK:skill)
                        //         createSK1ball();
                        //     break;
                        //     case 6:
                        //         // 创建小球加速道具
                        //         createSK2ball();
                        //     break;
                        //     case 7:
                        //         // 球板变短道具
                        //         createSK4ball();
                        //     break;
                        //     default:
                        //         // 创建粽子(可用)
                        //         createZongzi();
                        // }
                       
                        // 创建小球(可用)
                        // createBall();
                       

                    }
                    // 小球和底墙如果超速，创建新的小球替换
                    if (G.PSO_BALLWALL_B.flag){
                        G.stageLayer.removeChild(G.ball);
                        G.ball = null;
                        G.ball = new Ball();
                        G.ball.x =  G.PSO_BALLWALL_B.x+15;
                        G.ball.y =  G.PSO_BALLWALL_B.y+15;
                        G.stageLayer.addChild(G.ball);
                        G.ball.addBodyCircle(15,0,0,1,G.midu_config,G.mormal_config2,G.boll_config);
                        // 随机角度处理
                        if(G.PSO_BALLWALL_B.y<(G.GAME_HEIGHT-350+23)){
                            if(G.direflag){
                                var angle = -Math.PI/4;
                            }else {
                                var angle = -3*Math.PI/4;
                            }
                            if(G.ball2){
                                if(G.direflag2){
                                    var angle = -Math.PI/4;
                                }else {
                                    var angle = -3*Math.PI/4;
                                }
                            }
                        }else {
                             if(G.direflag){
                                var angle = -7*Math.PI/4;
                            }else {
                                var angle = -5*Math.PI/4;
                            }
                            if(G.ball2){
                                if(G.direflag2){
                                    var angle = -7*Math.PI/4;
                                }else {
                                    var angle = -5*Math.PI/4;
                                }
                            }
                        }
                        
                        var force = 8;
                        var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
                        G.ball.box2dBody.ApplyImpulse(vec, G.ball.box2dBody.GetWorldCenter()) // 冲量
                        G.PSO_BALLWALL_B.flag = false;
                    }
                    // 小球和球板碰撞，如果超速，替换小球
                    if (G.PSO_BALLFLOOR.flag){
                        G.stageLayer.removeChild(G.ball);
                        G.ball = null;
                        G.ball = new Ball();
                        G.ball.x =  G.PSO_BALLFLOOR.x+15;
                        G.ball.y =  G.PSO_BALLFLOOR.y+15;
                        G.stageLayer.addChild(G.ball);
                        G.ball.addBodyCircle(15,0,0,1,G.midu_config,G.mormal_config2,G.boll_config);
                        // 随机角度处理
                        if(G.direflag){
                            var angle = -Math.PI/4;
                        }else {
                            var angle = -3*Math.PI/4;
                        }
                        if(G.ball2){
                            if(G.direflag2){
                                var angle = -Math.PI/4;
                            }else {
                                var angle = -3*Math.PI/4;
                            }
                        }
                        var force = 6;
                        var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
                        G.ball.box2dBody.ApplyImpulse(vec, G.ball.box2dBody.GetWorldCenter()) // 冲量
                        G.PSO_BALLFLOOR.flag = false;
                    }
                    // 小球和墙碰撞，如果超速，替换小球
                    if (G.PSO_BALLWALL.flag) {
                        G.stageLayer.removeChild(G.ball);
                        G.ball = null;
                        G.ball = new Ball();
                        G.ball.x =  G.PSO_BALLFLOOR.x+15;
                        G.ball.y =  G.PSO_BALLFLOOR.y+15;
                        G.stageLayer.addChild(G.ball);
                        G.ball.addBodyCircle(15,0,0,1,G.midu_config,G.mormal_config2,G.boll_config);

                        // 随机处理角度
                        if(G.walldireflag){
                            var angle = -3*Math.PI/2;
                        }else {
                            var angle = -Math.PI/2;
                        }
                        if(G.ball2){
                            if(G.walldireflag){
                                var angle = -3*Math.PI/2;
                            }else {
                                var angle = -Math.PI/2;
                            }
                        }
                        var force = 8;
                        var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
                        G.ball.box2dBody.ApplyImpulse(vec, G.ball.box2dBody.GetWorldCenter()) // 冲量
                        G.PSO_BALLWALL.flag = false;
                    }
                    // SK1和挡板的碰撞跟踪
                    if (G.PSO_SK1FLOOR.flag){
                        // 创建朝上发射的小球
                        createBall();
                    }
                    // SK4和挡板的碰撞跟踪
                    if (G.PSO_SK4FLOOR.flag){
                        G.stageLayer.removeChild(G.floor);
                        G.floor = null;
                        // 创建短的球板
                        createShortFloor();
                        G.PSO_SK4FLOOR.flag = false;
                    }
                    break;
                // 游戏结束
                case 3:
                    gameover();
                    G.globalState = 0;
                    break;
                default:
           } 
        }
        function createZongzi() {
            var zongzi = new Zongzi();
            zongzi.x = G.PSO.x;
            zongzi.y = G.PSO.y;
            zongzi.rotate = 0;
            G.stageLayer.addChild(zongzi);
            G.daojuArr.push(zongzi);

            LTweenLite.to(zongzi,5,{rotate:2000,loop:true});
        }
        function createSK1ball() {
            var sk1ball = new SK1();
            sk1ball.x = G.PSO.x;
            sk1ball.y = G.PSO.y;
            G.stageLayer.addChild(sk1ball);
            sk1ball.addBodyCircle(41.5,0,0,1,0,G.mormal_config2,G.normal_config);
        }
        function createSK2ball() {
            var sk2ball = new SK2();
            sk2ball.x = G.PSO.x;
            sk2ball.y = G.PSO.y;
            G.stageLayer.addChild(sk2ball);
            sk2ball.addBodyCircle(41.5,0,0,1,0,G.mormal_config2,G.normal_config);
        }
        function createSK3ball() {
            var sk3ball = new SK3();
            sk3ball.x = G.PSO.x;
            sk3ball.y = G.PSO.y;
            G.stageLayer.addChild(sk3ball);
            sk3ball.addBodyCircle(41.5,0,0,1,0,G.mormal_config2,G.normal_config);
        }
        function createSK4ball() {
            var sk4ball = new SK4();
            sk4ball.x = G.PSO.x;
            sk4ball.y = G.PSO.y;
            G.stageLayer.addChild(sk4ball);
            sk4ball.addBodyPolygon(83,83,1,0,G.mormal_config2,G.normal_config);
        }
        function createBall() {
            G.ball2 = new Ball();
            G.ball2.x = G.PSO_SK1FLOOR.x;
            G.ball2.y = G.PSO_SK1FLOOR.y;
            G.stageLayer.addChild(G.ball2);
            G.ball2.addBodyCircle(15,0,0,1,G.midu_config,G.mormal_config2,G.boll_config);
            G.PSO_SK1FLOOR.flag = false;
            var angle = -Math.PI/2;
            var force = 10;
            var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
            G.ball2.box2dBody.ApplyImpulse(vec, G.ball2.box2dBody.GetWorldCenter()) // 冲量
        }
        function createShortFloor() {
            G.floor = new ShortFloor();
            G.floor.x = G.PSO_SK4FLOOR.x;
            G.floor.y = G.GAME_HEIGHT-120+8;
            G.stageLayer.addChild(G.floor);
            G.floor.addBodyPolygon(87,16,0,1,G.mormal_config2,G.floor_Config);
        }
        // 碰撞(问题1：无法给动态的刚体添加力,可能是要清除所有力，再添加力；但是添加冲量的效果很明显;问题2：碰撞的时间里面无法创建新的刚体，m_flags有值，创建被锁直接跳出方法)
        function postSolve(contact,impulse) {
            var objA = contact.GetFixtureA().GetBody().GetUserData();
            var objB = contact.GetFixtureB().GetBody().GetUserData();
            // 方块和球，地板和球，粽子和球
            if(objA.name == "ball" && (objB.name == "box" || objB.name == "hardBox")){
                
                boxBallFn(objB,objA);
            }else if((objA.name == "box" || objA.name == "hardBox") && objB.name == "ball"){
                
                boxBallFn(objA,objB);
            }else if(objA.name == "ball" && objB.name == "floor" && G.globalState==2){
                
                floorBallFn(objB,objA,impulse);
            }else if(objA.name == "floor" && objB.name == "ball" && G.globalState==2){
                
                floorBallFn(objA,objB,impulse);
            }else if(objA.name == "floor" && objB.name == "zongzi"){
                
                zongziBall(objB,objA);
            }else if(objA.name == "zongzi" && objB.name == "floor"){

                zongziBall(objA,objB);
            }else if(objA.name == "SK1" && objB.name == "floor" && G.globalState==2){

                SK1Floor(objA,objB);
            }else if(objA.name == "floor" && objB.name == "SK1" && G.globalState==2){

                SK1Floor(objB,objA);
            }else if(objA.name == "SK2" && objB.name == "floor" && G.globalState==2){

                SK2Floor(objA,objB);
            }else if(objA.name == "floor" && objB.name == "SK2" && G.globalState==2){

                SK2Floor(objB,objA);
            }else if(objA.name == "SK3" && objB.name == "floor" && G.globalState==2){

                SK3Floor(objA,objB);
            }else if(objA.name == "floor" && objB.name == "SK3" && G.globalState==2){

                SK3Floor(objB,objA);
            }else if(objA.name == "SK4" && objB.name == "floor" && G.globalState==2){

                SK4Floor(objA,objB);
            }else if(objA.name == "floor" && objB.name == "SK4" && G.globalState==2){

                SK4Floor(objB,objA);
            }else if(objA.name == "wall" && objB.name == "ball" && G.globalState==2) {

                wallBall(objA,objB,impulse);
            }else if(objA.name == "ball" && objB.name == "wall" && G.globalState==2){
        
                wallBall(objB,objA,impulse);
            }else if(objA.name == "bottomwall" && objB.name == "ball" && G.globalState==2){

                bottomwallBall(objA,objB,impulse);
            }else if(objA.name == "ball" && objB.name == "bottomwall" && G.globalState==2){

                bottomwallBall(objB,objA,impulse);
            }
        }
        /*碰撞逻辑处理*/
        // 方块和球碰撞
        function boxBallFn(bodyBox,bodyball) {
            MySoundPlayer.playSound("duang");
            // 处理打两次才消除的方块
            if(bodyBox.name == "box"){
                G.stageLayer.removeChild(bodyBox);
                G.PSO.flag = true;
            }else if( bodyBox.name == "hardBox" && bodyBox.num == 0){
                bodyBox.num++;
                bodyBox.alpha = 0.5;
            }else {
                G.stageLayer.removeChild(bodyBox);
                G.PSO.flag = true;
            }
            // 撞击的缓动动画
            if(G.overflag){
                G.halo = new Halo();
                G.halo.x = bodyBox.x+26;
                G.halo.y = bodyBox.y+24;
                G.halo.scaleX = 0.5;
                G.halo.scaleY = 0.5;
                G.stageLayer.addChild(G.halo);
                G.overflag = false;
            }
            LTweenLite.to(G.halo,0.2,{scaleX:3,scaleY:3,onComplete:function(){
                G.stageLayer.removeChild(G.halo);
                G.overflag = true;
            }});
            // 道具随机掉落的初始位置
            G.PSO.x =  bodyBox.x;
            G.PSO.y =  bodyBox.y;
        }
        // 两边的墙和球碰撞
        function wallBall(bodywall,bodyball,impulse) {
            G.PSO_BALLWALL.x = bodyball.x;
            G.PSO_BALLWALL.y = bodyball.y;
            if(impulse>G.config_impulse-1) {
                G.PSO_BALLWALL.flag =true;
            }else {
                // 随机处理角度
                if(G.walldireflag  || G.reflag_x){
                    var angle = -3*Math.PI/2;
                }else {
                    var angle = -Math.PI/2;
                }
                if(G.ball2){
                    if(G.walldireflag){
                        var angle = -3*Math.PI/2;
                    }else {
                        var angle = -Math.PI/2;
                    }
                }
                var vec = new LGlobal.box2d.b2Vec2(G.forcewallball*Math.cos(angle),G.forcewallball*Math.sin(angle)); // 施加固定角度的力
                bodyball.box2dBody.ApplyImpulse(vec, bodyball.box2dBody.GetWorldCenter()) // 冲量
            }
        }

        // 球板和球碰撞
        function floorBallFn(bodyFloor,bodyball,impulse){
            G.PSO_BALLFLOOR.x = bodyball.x;
            G.PSO_BALLFLOOR.y = bodyball.y;
            if(impulse.normalImpulses[0]>G.config_impulse){
                G.PSO_BALLFLOOR.flag = true;
            }else{
                 // 随机角度处理
                if(G.direflag){
                    var angle = -Math.PI/4;
                }else {
                    var angle = -3*Math.PI/4;
                }
                if(G.ball2){
                    if(G.direflag2){
                        var angle = 0;
                    }else {
                        var angle = -Math.PI;
                    }
                }
                var vec = new LGlobal.box2d.b2Vec2(G.forcefloorball*Math.cos(angle),G.forcefloorball*Math.sin(angle)); // 施加固定角度的力
                // G.ball.box2dBody.ApplyForce(vec,G.ball.box2dBody.GetWorldCenter()); // 失效
                bodyball.box2dBody.ApplyImpulse(vec, bodyball.box2dBody.GetWorldCenter()) // 冲量
            }
        }

        // 底墙和球碰撞
        function bottomwallBall(bodybottomwall,bodyball,impulse) {
            // 改变球的方向
            if((84<bodyball.x　&& bodyball.x<180) || (274<bodyball.x　&& bodyball.x<368) || (460<bodyball.x　&& bodyball.x<554)){
                if(impulse.normalImpulses[0]>G.config_impulse){
                    G.PSO_BALLWALL_B.x = bodyball.x;
                    G.PSO_BALLWALL_B.y = bodyball.y;
                    G.PSO_BALLWALL_B.flag = true;
                }
            }
            // 避免原地重弹
            if(G.reflag){
                var angle = -3*Math.PI/4;
                var vec = new LGlobal.box2d.b2Vec2(G.forcefloorball*Math.cos(angle),G.forcefloorball*Math.sin(angle)); // 施加固定角度的力
                bodyball.box2dBody.ApplyImpulse(vec, bodyball.box2dBody.GetWorldCenter()) // 冲量
            }
        }

        // 粽子和球板碰撞
        function zongziBall(bodyZongzi,bodyFloor){
            if(G.globalState==2){
                G.stageLayer.removeChild(bodyZongzi);
                G.score += 20;
                console.log(G.score);
            }else {
                G.stageLayer.removeChild(bodyZongzi);
            }
        }
        // 道具(双球)和球板碰撞
        function SK1Floor(bodySK1,bodyFloor){
            G.stageLayer.removeChild(bodySK1);
            G.PSO_SK1FLOOR.x = bodySK1.x;
            G.PSO_SK1FLOOR.y = bodySK1.y;
            G.PSO_SK1FLOOR.flag = true;
        }
        // 道具(加速)和球板碰撞
        function SK2Floor(bodySK2,bodyFloor){
            G.stageLayer.removeChild(bodySK2);
            // 小球加速
            var angle = -Math.PI/2;
            var force = 100;
            var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
            G.ball.box2dBody.ApplyImpulse(vec, G.ball.box2dBody.GetWorldCenter()) // 冲量
            if(G.ball2){
                 G.ball2.box2dBody.ApplyImpulse(vec, G.ball2.box2dBody.GetWorldCenter()) // 冲量
            }
        }
        // 道具(gameOver)和球板碰撞
        function SK3Floor(bodySK3,bodyFloor){
            G.stageLayer.removeChild(bodySK3);
            //  gameOver
            G.globalState=3;
        }
        // 道具(球板变短)和球板碰撞
        function SK4Floor(bodySK4,bodyFloor){
            G.stageLayer.removeChild(bodySK4);
            G.PSO_SK4FLOOR.x = bodySK4.x;
            G.PSO_SK4FLOOR.y = bodyFloor.y;
            G.PSO_SK4FLOOR.flag = true;

        }
        // 鼠标/触屏动画(按下，移动，抬起)
        function onmousedown(event) {
            G.flag = true;
        }
        function onmousemove(event) {
            /**
            * 使用SetPosition设定刚体位置的时候，参数也是box2d世界中的单位。
            * 而box2d世界中的单位和像素值之间的换算单位是LGlobal.box2d.drawScale，也就是
            * 像素坐标＝box2d中的坐标/LGlobal.box2d.drawScale；
            * 当然，重新设定了坐标之后，要唤醒刚体
            */
            if(G.flag){
                if(event.offsetX>=87 && event.offsetX<=553){
                    G.floor.box2dBody.SetPosition(new LGlobal.box2d.b2Vec2(event.offsetX/LGlobal.box2d.drawScale,G.floor.box2dBody.GetPosition().y));
                    if(G.globalState==1){
                        G.ball.box2dBody.SetPosition(new LGlobal.box2d.b2Vec2(event.offsetX/LGlobal.box2d.drawScale,G.ball.box2dBody.GetPosition().y));
                    }
                }
                G.floor.box2dBody.SetAwake(true);
            }
        }
        function onmouseup(event) {
             G.flag = false;
        }
        /*Tools fn*/
        // 写时间
        function writeTime(time,field,TIME_X,TIME_Y,TIME_SIZE,TIME_COLOR) {
            field.text = time;
            field.x = TIME_X;
            field.y = TIME_Y;
            field.size = TIME_SIZE;
            field.color = TIME_COLOR;
            field.weight = "bolder";
            // G.stageLayer.graphics.drawRect(2, "#ff0000", [ G.stageLayer.x-14,  G.stageLayer.y,  G.stageLayer.getWidth(),  G.stageLayer.getHeight()], true, "#880088");
        }
        // 记分
        function markScore(score) {
            G.fieldScore.text = score;
            G.fieldScore.x = 485;
            G.fieldScore.y = 53;
            G.fieldScore.size = 20;
            G.fieldScore.color = "white";
            G.fieldScore.weight = "bolder";
        }
        // 随机角度发射
        function shoot(flag) {
            if(flag){
                var arr = [-5*Math.PI/12,-7*Math.PI/12];
                var angle = arr[parseInt(Math.random()*2)];
                var vec = new LGlobal.box2d.b2Vec2( G.force*Math.cos(angle), G.force*Math.sin(angle));
                G.ball.box2dBody.ApplyForce(vec,G.ball.box2dBody.GetWorldCenter());
            }
        }
        // 倒计时(3s)
        function doTimeDown(time){
            var timer = setInterval(function(){
                if(time > 1){
                    if(writeTime && typeof writeTime == "function"){
                        writeTime(time,G.field,292,600,100,"#333");
                        time--;
                    }
                }else if(time==1 && (doGameTimeDown && typeof doGameTimeDown == "function")) {
                     writeTime(time,G.field,292,600,100,"#333");
                     time--;
                     // 游戏倒计时
                     doGameTimeDown(300);
                }else{
                    if(shoot && typeof shoot == "function"){
                        G.backLayer.removeChild(G.field);
                        clearInterval(timer);
                        shoot(true);
                        G.globalState=2;

                    }
                }
            },1000);
        }
        // 游戏倒计时(300s)
        function doGameTimeDown(time) {
            var timer = setInterval(function(){
                if(G.globalState == 0){
                     clearInterval(timer);
                }
                if(time>=0){
                    if(writeTime && typeof writeTime == "function"){
                        writeTime(time,G.fieldTime,204,53,20,"white");
                        time--;
                    }
                }else{
                    G.backLayer.removeChild(G.fieldTime);
                    clearInterval(timer);
                    G.globalState=3;
                }
            },1000);
        }
        // 重力抵消
        function nog(body) {
            if(body){
                // 抵消重力  var force = -10*body.GetMass();
                var force = -G.g*body.GetMass();
                var angle = -3*Math.PI/2;
                var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
                body.ApplyForce(vec,body.GetWorldCenter());
                body.SetAwake(true);
            }
           
        }
        // 抵消部分重力
         function nootherg(body,g) {
            // 抵消重力  var force = -10*body.GetMass();
            var force = -g*0.01;
            var angle = -3*Math.PI/2;
            var vec = new LGlobal.box2d.b2Vec2(force*Math.cos(angle),force*Math.sin(angle)); // 施加固定角度的力
            body.ApplyImpulse(vec,body.GetWorldCenter());
            body.SetAwake(true);
        }
        // 背景层，舞台层，顶层，地板层，小球层，光圈层，粽子(刚体)，技能球(SK1-SK4)，底墙层(创建方块的刚体)，方块层(创建方块刚体)，
        // name属性全小写(除开SK1-SK4)
        function Background() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["bg2"],0,0,640,1030);
            self.bitmap = new LBitmap(self.bitmapData);
            var sy = G.GAME_HEIGHT/self.bitmapData.height;// 缩放，将背景图拉伸至全屏
            self.bitmap.scaleY = sy;
            self.addChild(self.bitmap);
        }
        function stageInit() {
            G.stageLayer = new LSprite();
            G.backLayer.addChild(G.stageLayer);
        } 
        function Top() {
            base(this, LSprite, []);
            var self = this;
            self.bitmapData = new LBitmapData(G.imglist["top"],0,0,640,133);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap);
        }
        function Wall() {
            base(this, LSprite, []);
            var self = this;
            self.name = "wall";
            self.bitmapData = new LBitmapData(G.imglist["wall"],0,0,22,1006);
            self.bitmap = new LBitmap(self.bitmapData);
            var sy = G.GAME_HEIGHT/self.bitmapData.height;// 缩放，将背景图拉伸至全屏
            self.bitmap.scaleY = sy;
            self.addChild(self.bitmap);
        }
        function ShortFloor() {
            base(this, LSprite, []);
            var self = this;
            self.name = "floor";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],304,282,87,16);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap);
        }
        function Floor() {
            base(this, LSprite, []);
            var self = this;
            self.name = "floor";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],537,166,130,16);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap);
        }
        function Ball() {
            base(this, LSprite, []);
            var self = this;
            self.name = "ball";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],359,158,30,29);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap); 
        }
        function Halo() {
            base(this, LSprite, []);
            var self = this;
            self.name = "halo";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],204,259,70,68);
            self.bitmap = new LBitmap(self.bitmapData);
            self.bitmap.x = -self.bitmap.getWidth()*0.5;
            self.bitmap.y = -self.bitmap.getHeight()*0.5;
            self.addChild(self.bitmap); 
        }
        function Zongzi() {
            base(this, LSprite, []);
            var self = this;
            self.name = "zongzi";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],21,254,64,60);
            self.bitmap = new LBitmap(self.bitmapData);
            self.bitmap.x = -self.bitmap.getWidth()*0.5;
            self.bitmap.y = -self.bitmap.getHeight()*0.5;
            self.addChild(self.bitmap); 
        }
        function SK1() {
            base(this, LSprite, []);
            var self = this;
            self.name = "SK1";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],251,15,83,83);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap); 
        }
        function SK2() {
            base(this, LSprite, []);
            var self = this;
            self.name = "SK2";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],496,15,83,83);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap); 
        }
        function SK3() {
            base(this, LSprite, []);
            var self = this;
            self.name = "SK3";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],374,15,83,83);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap); 
        } 
        function SK4() {
            base(this, LSprite, []);
            var self = this;
            self.name = "SK4";
            self.bitmapData = new LBitmapData(G.imglist["sprite"],740,15,83,83);
            self.bitmap = new LBitmap(self.bitmapData);
            self.addChild(self.bitmap); 
        } 
        function bottomWall() {
            // base(this, LSprite, []);
            var self = this;
            // self.name = "bottomwall";
            // self.bitmapData = new LBitmapData(G.imglist["sprite"],216,158,97,46);
            // self.bitmap = new LBitmap(self.bitmapData);
            // self.addChild(self.bitmap); 
        }
        bottomWall.prototype = {
            getbottomWall : function(START_X,START_Y){
                var sprite = new LSprite();
                sprite.name = "bottomwall";
                var bitmapData = new LBitmapData(G.imglist["sprite"],216,158,97,46);
                var bitmap = new LBitmap(bitmapData);
                sprite.addChild(bitmap);

                sprite.x = START_X + (bitmap.getWidth()/2);
                sprite.y = START_Y + (bitmap.getHeight()/2);
                G.stageLayer.addChild(sprite);
                sprite.addBodyPolygon(bitmap.getWidth(),bitmap.getHeight(),0,5,0.4,G.normal_config);
            }
        }
        function Box() {
            var self = this;
            self.box1 = [[1,1,1,1],
                         [1,1,1,0],
                         [1,1,0,0],
                         [1,0,0,0]];
            self.box2 = [[1,0,0,0],
                         [1,1,0,0],
                         [1,1,1,0],
                         [1,1,1,1]];
            self.box3 = [[1,1,1,1],
                         [0,1,1,1],
                         [0,0,1,1],
                         [0,0,0,1]];
            self.box4 = [[0,0,0,1],
                         [0,0,1,1],
                         [0,1,1,1],
                         [1,1,1,1]];
            self.box5 = [[0,0,1,1,0,0],
                         [0,1,1,1,1,0],
                         [1,1,1,1,1,1],
                         [1,1,1,1,1,1],
                         [0,1,1,1,1,0],
                         [0,0,1,1,0,0]];
        }
        Box.prototype = {
            getBox : function(box,START_X,START_Y,imgObj,arr) {
                var i,j,bitmap;
	            for(i=0;i<box.length;i++){
                    for(j=0;j<box[0].length;j++){
                        if(box[i][j] == 0){
                            continue;
                        }
                        var sprite = new LSprite();
                        sprite.name = "box";
                        var bitmapData = new LBitmapData(imgObj,arr[0],arr[1],arr[2],arr[3]);
                        var bitmap = new LBitmap(bitmapData);
                        sprite.addChild(bitmap);

                        sprite.x = (bitmap.getWidth()*j+START_X) + (bitmap.getWidth()/2);
                        sprite.y = (bitmap.getHeight()*i+START_Y) + (bitmap.getHeight()/2);
                        G.stageLayer.addChild(sprite);
                        sprite.addBodyPolygon(bitmap.getWidth(),bitmap.getHeight(),0,5,0.4,G.normal_config);
                    }
                }
            },
            getHardBox : function(box,START_X,START_Y,imgObj,arr) {
                var i,j,bitmap;
	            for(i=0;i<box.length;i++){
                    for(j=0;j<box[0].length;j++){
                        if(box[i][j] == 0){
                            continue;
                        }
                        var sprite = new LSprite();
                        sprite.name = "hardBox";
                        sprite.num = 0;
                        var bitmapData = new LBitmapData(imgObj,arr[0],arr[1],arr[2],arr[3]);
                        var bitmap = new LBitmap(bitmapData);
                        sprite.addChild(bitmap);

                        sprite.x = (bitmap.getWidth()*j+START_X) + (bitmap.getWidth()/2);
                        sprite.y = (bitmap.getHeight()*i+START_Y) + (bitmap.getHeight()/2);
                        G.stageLayer.addChild(sprite);
                        sprite.addBodyPolygon(bitmap.getWidth(),bitmap.getHeight(),0,5,0.4,G.normal_config);
                    }
                }
            }
        }

        /*音乐*/
        function SoundPlayer(){
            var self = this;
            self.loadIndex = 0;
            self.background = new LSound();
            self.background.parent = self;
            //如果IOS环境，并且不支持WebAudio，则没有预先读取的音频
            if(LGlobal.ios && !LSound.webAudioEnabled){
                return;
            }
            //如果没有预先读取的音频
            if(!G.imglist["sound_background"]){
                return;
            }
            
            self.background.addEventListener(LEvent.COMPLETE,self.backgroundLoadComplete);
            self.background.load(G.imglist["sound_background"]);
            //如果是移动浏览器，并且不支持WebAudio，则无法适用多声道，所以只适用背景音乐
            if(LGlobal.mobile && !LSound.webAudioEnabled){
                return;
            }
            self.duang = new LSound();
            self.duang.parent = self;
            
            self.duang.addEventListener(LEvent.COMPLETE,self.duangLoadComplete);
            self.duang.load(G.imglist["duang"]);
        }
        SoundPlayer.prototype.loadSound = function(){
            var self = this;
            //如果支持WebAudio，则已经预先读取了音频，无需再次读取
            if(LSound.webAudioEnabled){
                if (LGlobal.mobile){
                    switch(self.loadIndex++){
                        case 0:
                            self.duang.play(self.duang.length);
                            break;
                    }
                }
                return;
            }
            //已读取音频，无需再次读取
            if(self.loadIndex > 0 ){
                return;
            }
            self.loadIndex++;
            self.background.addEventListener(LEvent.COMPLETE,self.backgroundLoadComplete);
            self.background.load("./images/game music.mp3");
        };
        SoundPlayer.prototype.playSound = function(name){
            var self = this;
            switch(name){
                case "duang":
                    if(!self.duangIsLoad)return;
                    self.duang.play(0,1);
                    break;
            }
        };
        SoundPlayer.prototype.backgroundLoadComplete = function(event){
            var self = event.currentTarget;
            self.parent.backgroundIsLoad = true;
            self.play(0,100);
        };
        SoundPlayer.prototype.duangLoadComplete = function(event){
            var self = event.currentTarget;
            self.parent.duangIsLoad = true;
        };
    })();
    </script>
</body>
</html>